<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="/jersey-netty-cdi-jackson-file-eventstore/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/jersey-netty-cdi-jackson-file-eventstore/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/jersey-netty-cdi-jackson-file-eventstore/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/jersey-netty-cdi-jackson-file-eventstore/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Jersey Netty CDI Jackson File EventStore | EventStore</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="Jersey Netty CDI Jackson File EventStore" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Building File based event-store with Jackson JSON Serialisation and Deserialization, Jersey REST API uses Netty runtime and Weld CDI" /> <meta property="og:description" content="Building File based event-store with Jackson JSON Serialisation and Deserialization, Jersey REST API uses Netty runtime and Weld CDI" /> <link rel="canonical" href="/jersey-netty-cdi-jackson-file-eventstore/" /> <meta property="og:url" content="/jersey-netty-cdi-jackson-file-eventstore/" /> <meta property="og:site_name" content="EventStore" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2019-09-01T02:11:51+00:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Jersey Netty CDI Jackson File EventStore" /> <script type="application/ld+json"> {"description":"Building File based event-store with Jackson JSON Serialisation and Deserialization, Jersey REST API uses Netty runtime and Weld CDI","@type":"WebSite","headline":"Jersey Netty CDI Jackson File EventStore","url":"/jersey-netty-cdi-jackson-file-eventstore/","dateModified":"2019-09-01T02:11:51+00:00","datePublished":"2019-09-01T02:11:51+00:00","name":"EventStore","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <link rel="shortcut icon" type="image/x-icon" href="/jersey-netty-cdi-jackson-file-eventstore//assets/images/favicon.ico"> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/jersey-netty-cdi-jackson-file-eventstore/" class="site-title lh-tight"> EventStore </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/jersey-netty-cdi-jackson-file-eventstore/docs/arquillian.html" class="nav-list-link">Arquillian guide</a></li><li class="nav-list-item"><a href="/jersey-netty-cdi-jackson-file-eventstore/docs/quick-start.html" class="nav-list-link">Developer Guide</a></li><li class="nav-list-item active"><a href="/jersey-netty-cdi-jackson-file-eventstore/" class="nav-list-link active">Jersey Netty CDI Jackson File EventStore</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search EventStore" aria-label="Search EventStore" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <h1 id="jersey-netty-cdi-jackson-file-eventstore-"> <a href="#jersey-netty-cdi-jackson-file-eventstore-" class="anchor-heading" aria-labelledby="jersey-netty-cdi-jackson-file-eventstore-"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Jersey Netty CDI Jackson File EventStore <a href="https://travis-ci.org/daggerok/jersey-netty-cdi-jackson-file-eventstore"><img src="https://travis-ci.org/daggerok/jersey-netty-cdi-jackson-file-eventstore.svg?branch=master" alt="Build Status" /></a> </h1> <p>Building File based event-store with Jackson JSON Serialisation / Deserialization, Jersey REST API uses Netty runtime and Weld CDI</p> <h2 id="jersey-netty-and-cdi"> <a href="#jersey-netty-and-cdi" class="anchor-heading" aria-labelledby="jersey-netty-and-cdi"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Jersey (Netty) and CDI </h2> <p>tiny, fast and dead-simple!</p> <p><em>pom.xml</em></p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>

  <span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;mainClass&gt;</span>daggerok.Main<span class="nt">&lt;/mainClass&gt;</span>

    <span class="nt">&lt;jersey.version&gt;</span>2.29<span class="nt">&lt;/jersey.version&gt;</span>
    <span class="nt">&lt;jandex.version&gt;</span>2.1.1.Final<span class="nt">&lt;/jandex.version&gt;</span>

    <span class="nt">&lt;jandex-maven-plugin.version&gt;</span>1.0.6<span class="nt">&lt;/jandex-maven-plugin.version&gt;</span>
    <span class="nt">&lt;capsule-maven-plugin.version&gt;</span>1.5.1<span class="nt">&lt;/capsule-maven-plugin.version&gt;</span>
  <span class="nt">&lt;/properties&gt;</span>

  <span class="nt">&lt;dependencyManagement&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jersey-bom<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${jersey.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
  <span class="nt">&lt;/dependencyManagement&gt;</span>

  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.jboss<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jandex<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${jandex.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.inject<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-cdi2-se<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.containers<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-container-netty-http<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${jersey.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>

  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="c">&lt;!-- CDI index --&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.jboss.jandex<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jandex-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${jandex-maven-plugin.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;id&gt;</span>make-index<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>jandex<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;phase&gt;</span>process-classes<span class="nt">&lt;/phase&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>

      <span class="c">&lt;!-- fat jar --&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.github.chrisdchristo<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>capsule-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${capsule-maven-plugin.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>build<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;fileDesc&gt;</span>-all<span class="nt">&lt;/fileDesc&gt;</span>
              <span class="nt">&lt;appClass&gt;</span>${mainClass}<span class="nt">&lt;/appClass&gt;</span>
              <span class="nt">&lt;type&gt;</span>fat<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
</code></pre></div></div> <h3 id="entry-point"> <a href="#entry-point" class="anchor-heading" aria-labelledby="entry-point"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> entry point </h3> <p><em>Main.java</em></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="kd">extends</span> <span class="nc">ResourceConfig</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Main</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">packages</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="nc">Main</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getPackage</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Channel</span> <span class="n">server</span> <span class="o">=</span> <span class="nc">NettyHttpContainerProvider</span><span class="o">.</span><span class="na">createHttp2Server</span><span class="o">(</span>
                <span class="no">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"http://127.0.0.1:8080/"</span><span class="o">),</span>
                <span class="nc">ResourceConfig</span><span class="o">.</span><span class="na">forApplicationClass</span><span class="o">(</span><span class="nc">Main</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="kc">null</span><span class="o">);</span>

        <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">server:</span><span class="o">:</span><span class="n">close</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="fallback"> <a href="#fallback" class="anchor-heading" aria-labelledby="fallback"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> fallback </h3> <p><em>ErrorMapper.java</em></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Log4j2</span>
<span class="nd">@Provider</span>
<span class="nd">@RequestScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErrorMapper</span> <span class="kd">implements</span> <span class="nc">ExceptionMapper</span><span class="o">&lt;</span><span class="nc">Exception</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Context</span>
    <span class="nc">UriInfo</span> <span class="n">uriInfo</span><span class="o">;</span>

    <span class="nd">@Context</span>
    <span class="nc">Request</span> <span class="n">request</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Response</span> <span class="nf">toResponse</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"{} {}"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">exception</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">(),</span> <span class="n">exception</span><span class="o">);</span>

        <span class="k">return</span> <span class="nc">Response</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">Response</span><span class="o">.</span><span class="na">Status</span><span class="o">.</span><span class="na">BAD_REQUEST</span><span class="o">)</span>
                       <span class="o">.</span><span class="na">entity</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="na">createObjectBuilder</span><span class="o">()</span>
                                   <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">exception</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">())</span>
                                                         <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="s">"empty"</span><span class="o">))</span>
                                   <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"_links"</span><span class="o">,</span> <span class="nc">Json</span><span class="o">.</span><span class="na">createObjectBuilder</span><span class="o">()</span>
                                                      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"_self"</span><span class="o">,</span> <span class="n">uriInfo</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span>
                                                                           <span class="o">.</span><span class="na">toString</span><span class="o">())</span>
                                                      <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                                   <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                       <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                       <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p><em>HealthResource.java</em> + some fallback also:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestScoped</span>
<span class="nd">@Consumes</span><span class="o">(</span><span class="no">WILDCARD</span><span class="o">)</span>
<span class="nd">@Produces</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HealthResource</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">on</span><span class="o">(</span><span class="nd">@Observes</span> <span class="nc">ContainerInitialized</span> <span class="n">containerInitializedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">containerInitializedEvent</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GET</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">"health"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">JsonObject</span> <span class="nf">health</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"health"</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Json</span><span class="o">.</span><span class="na">createObjectBuilder</span><span class="o">()</span>
                   <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"status"</span><span class="o">,</span> <span class="s">"UP"</span><span class="o">)</span>
                   <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@GET</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">"{path:(.*)?}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">JsonObject</span> <span class="nf">getAny</span><span class="o">(</span><span class="nd">@PathParam</span><span class="o">(</span><span class="s">"path"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"unexpected GET"</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">info</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">JsonObject</span> <span class="nf">info</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Json</span><span class="o">.</span><span class="na">createObjectBuilder</span><span class="o">()</span>
                   <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"path"</span><span class="o">,</span> <span class="s">""</span> <span class="o">+</span> <span class="n">path</span><span class="o">)</span>
                   <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h2 id="jackson-json-support"> <a href="#jackson-json-support" class="anchor-heading" aria-labelledby="jackson-json-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Jackson JSON support </h2> <p>maven dependencies in <em>pom.xml</em> file</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;jersey.version&gt;</span>2.29<span class="nt">&lt;/jersey.version&gt;</span>
    <span class="nt">&lt;jackson.version&gt;</span>2.10.0.pr2<span class="nt">&lt;/jackson.version&gt;</span>
  <span class="nt">&lt;/properties&gt;</span>

  <span class="nt">&lt;dependencyManagement&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jersey-bom<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${jersey.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jackson-bom<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${jackson.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
  <span class="nt">&lt;/dependencyManagement&gt;</span>

  <span class="nt">&lt;dependencies&gt;</span>
    <span class="c">&lt;!-- Jackson Jersey support --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.containers<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-container-netty-http<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!--
      1. Serialization / Deserialization of abstract types (such as DomainEvent)
         by using Jackson type feature
      2. REST API: Input List of DomainEvents as Request Body
    --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.media<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-media-json-jackson<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- REST API: javax.json.Json / javax.json.JsonObject --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.media<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-media-json-processing<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- Jackson ObjectMapper --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- ZonedDateTime Format and Serialization / Deserialization --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.datatype<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jackson-datatype-jsr310<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div></div> <p>In order to let Jackson properly understand how to deserialize json into abstract type, we have to configure its abstract type mappings (see <code class="language-plaintext highlighter-rouge">@@JsonSubTypes</code> annotations):</p> <p><em>DomainEvent.java</em></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@JsonTypeInfo</span><span class="o">(</span>
        <span class="n">use</span> <span class="o">=</span> <span class="nc">JsonTypeInfo</span><span class="o">.</span><span class="na">Id</span><span class="o">.</span><span class="na">NAME</span><span class="o">,</span>
        <span class="n">property</span> <span class="o">=</span> <span class="s">"type"</span>
<span class="o">)</span>
<span class="nd">@JsonSubTypes</span><span class="o">({</span>
        <span class="nd">@JsonSubTypes</span><span class="o">.</span><span class="na">Type</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"CounterCreated"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nc">CounterCreated</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="nd">@JsonSubTypes</span><span class="o">.</span><span class="na">Type</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"CounterIncremented"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nc">CounterIncremented</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="nd">@JsonSubTypes</span><span class="o">.</span><span class="na">Type</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"CounterSuspended"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nc">CounterSuspended</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DomainEvent</span> <span class="o">{</span>
    <span class="no">UUID</span> <span class="nf">getAggregateId</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> <p>All events are ValueObjects and can be created only via single constructor. In order to help Jackson properly understand how all these events can be deserialized into Java Object, we have to setup it’s <code class="language-plaintext highlighter-rouge">@JsonCreator</code> together with <code class="language-plaintext highlighter-rouge">@JsonProperty</code> pointing to concrete object field…</p> <p>Also, we don’t wanna show any empty or null fields in case they are has not been specified, so we are using <code class="language-plaintext highlighter-rouge">@JsonInclude</code> annotations…</p> <p>By design, all our event should should be relative to concrete aggregate, so they should have aggregateId as well:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CounterCreated</span> <span class="kd">implements</span> <span class="nc">DomainEvent</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">eventName</span> <span class="o">=</span> <span class="nc">CounterCreated</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>

    <span class="nd">@JsonInclude</span><span class="o">(</span><span class="nc">JsonInclude</span><span class="o">.</span><span class="na">Include</span><span class="o">.</span><span class="na">NON_NULL</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="no">UUID</span> <span class="n">aggregateId</span><span class="o">;</span>

    <span class="nd">@JsonInclude</span><span class="o">(</span><span class="nc">JsonInclude</span><span class="o">.</span><span class="na">Include</span><span class="o">.</span><span class="na">NON_EMPTY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">counterName</span><span class="o">;</span>

    <span class="nd">@JsonInclude</span><span class="o">(</span><span class="nc">JsonInclude</span><span class="o">.</span><span class="na">Include</span><span class="o">.</span><span class="na">NON_NULL</span><span class="o">)</span>
    <span class="nd">@JsonFormat</span><span class="o">(</span><span class="n">shape</span> <span class="o">=</span> <span class="nc">JsonFormat</span><span class="o">.</span><span class="na">Shape</span><span class="o">.</span><span class="na">STRING</span><span class="o">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd'T'HH:mm:ss.SSSZ"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ZonedDateTime</span> <span class="n">at</span><span class="o">;</span>

    <span class="nd">@JsonCreator</span>
    <span class="kd">public</span> <span class="nf">CounterCreated</span><span class="o">(</span><span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"aggregateId"</span><span class="o">)</span> <span class="no">UUID</span> <span class="n">aggregateId</span><span class="o">,</span>
                          <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"counterName"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">counterName</span><span class="o">,</span>
                          <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"at"</span><span class="o">)</span> <span class="nc">ZonedDateTime</span> <span class="n">at</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">this</span><span class="o">.</span><span class="na">aggregateId</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">aggregateId</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">counterName</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">counterName</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"counter-%d"</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">at</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">at</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="nc">ZonedDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="zoneddatetime"> <a href="#zoneddatetime" class="anchor-heading" aria-labelledby="zoneddatetime"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> ZonedDateTime </h3> <p>In order to have properly consumable format of <code class="language-plaintext highlighter-rouge">java.timr.ZonedDateTime</code> type, we have to configure Jackson <code class="language-plaintext highlighter-rouge">ObjectMapper</code> to be used in our serialization process in our app:</p> <p><em>JacksonConfig.java</em></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ApplicationScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JacksonConfig</span> <span class="o">{</span>

    <span class="nd">@Produces</span>
    <span class="kd">private</span> <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="nc">JsonMapper</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                  <span class="o">.</span><span class="na">addModules</span><span class="o">(</span><span class="k">new</span> <span class="nc">JavaTimeModule</span><span class="o">())</span>
                                                  <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">WRITE_DATES_AS_TIMESTAMPS</span><span class="o">)</span>
                                                  <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">WRITE_DURATIONS_AS_TIMESTAMPS</span><span class="o">)</span>
                                                  <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">DeserializationFeature</span><span class="o">.</span><span class="na">READ_DATE_TIMESTAMPS_AS_NANOSECONDS</span><span class="o">)</span>
                                                  <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS</span><span class="o">)</span>
                                                  <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">FAIL_ON_EMPTY_BEANS</span><span class="o">)</span>
                                                  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> <p>But we have to also care about Jersey! So we should properly configure Jersey ObjectMapper <code class="language-plaintext highlighter-rouge">ContextResolver</code> via provider</p> <p><em>JacksonProvider</em></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Provider</span>
<span class="nd">@ApplicationScoped</span>
<span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JacksonProvider</span> <span class="kd">implements</span> <span class="nc">ContextResolver</span><span class="o">&lt;</span><span class="nc">ObjectMapper</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ObjectMapper</span> <span class="nf">getContext</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">objectMapper</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>Because we previously configure <code class="language-plaintext highlighter-rouge">ObjectMapper</code> in <code class="language-plaintext highlighter-rouge">JacksonConfig.java</code> file we can (and should) re-use it!</p> <hr> <footer> <p class="text-small text-grey-dk-100 mb-0">Jersey Netty CDI Jackson File based EventStore. Copyright &copy; 2019 Maksim Kostromin.</p> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
