<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Jersey Netty CDI Jackson File EventStore - EventStore</title> <link rel="shortcut icon" href="/jersey-netty-cdi-jackson-file-eventstore/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/jersey-netty-cdi-jackson-file-eventstore/assets/css/just-the-docs.css"> <script type="text/javascript" src="/jersey-netty-cdi-jackson-file-eventstore/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/jersey-netty-cdi-jackson-file-eventstore/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Jersey Netty CDI Jackson File EventStore | EventStore</title> <meta name="generator" content="Jekyll v3.8.6" /> <meta property="og:title" content="Jersey Netty CDI Jackson File EventStore" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Building File based event-store with Jackson JSON Serialisation and Deserialization, Jersey REST API uses Netty runtime and Weld CDI" /> <meta property="og:description" content="Building File based event-store with Jackson JSON Serialisation and Deserialization, Jersey REST API uses Netty runtime and Weld CDI" /> <link rel="canonical" href="/jersey-netty-cdi-jackson-file-eventstore/" /> <meta property="og:url" content="/jersey-netty-cdi-jackson-file-eventstore/" /> <meta property="og:site_name" content="EventStore" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2019-09-01T02:11:51+00:00" /> <script type="application/ld+json"> {"description":"Building File based event-store with Jackson JSON Serialisation and Deserialization, Jersey REST API uses Netty runtime and Weld CDI","headline":"Jersey Netty CDI Jackson File EventStore","dateModified":"2019-09-01T02:11:51+00:00","datePublished":"2019-09-01T02:11:51+00:00","@type":"WebSite","url":"/jersey-netty-cdi-jackson-file-eventstore/","name":"EventStore","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <link rel="shortcut icon" type="image/x-icon" href="/jersey-netty-cdi-jackson-file-eventstore//assets/images/favicon.ico"> </head> <body> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="/jersey-netty-cdi-jackson-file-eventstore/" class="site-title lh-tight">EventStore</a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item active"><a href="/jersey-netty-cdi-jackson-file-eventstore/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="/jersey-netty-cdi-jackson-file-eventstore/docs/arquillian.html" class="navigation-list-link">Arquillian guide</a></li><li class="navigation-list-item active"><a href="/jersey-netty-cdi-jackson-file-eventstore/" class="navigation-list-link active">Jersey Netty CDI Jackson File EventStore</a></li><li class="navigation-list-item"><a href="/jersey-netty-cdi-jackson-file-eventstore/docs/quick-start.html" class="navigation-list-link">Developer Guide</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search EventStore" aria-label="Search EventStore" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <h1 id="jersey-netty-cdi-jackson-file-eventstore-"> <a href="#jersey-netty-cdi-jackson-file-eventstore-" class="anchor-heading"><svg class="d-inline-block v-align-middle" viewBox="0 0 16 16" version="1.1" width="18" height="18" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> Jersey Netty CDI Jackson File EventStore <a href="https://travis-ci.org/daggerok/jersey-netty-cdi-jackson-file-eventstore"><img src="https://travis-ci.org/daggerok/jersey-netty-cdi-jackson-file-eventstore.svg?branch=master" alt="Build Status" /></a> </h1> <p>Building File based event-store with Jackson JSON Serialisation / Deserialization, Jersey REST API uses Netty runtime and Weld CDI</p> <h2 id="jersey-netty-and-cdi"> <a href="#jersey-netty-and-cdi" class="anchor-heading"><svg class="d-inline-block v-align-middle" viewBox="0 0 16 16" version="1.1" width="18" height="18" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> Jersey (Netty) and CDI </h2> <p>tiny, fast and dead-simple!</p> <p><em>pom.xml</em></p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>

  <span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;mainClass&gt;</span>daggerok.Main<span class="nt">&lt;/mainClass&gt;</span>

    <span class="nt">&lt;jersey.version&gt;</span>2.29<span class="nt">&lt;/jersey.version&gt;</span>
    <span class="nt">&lt;jandex.version&gt;</span>2.1.1.Final<span class="nt">&lt;/jandex.version&gt;</span>

    <span class="nt">&lt;jandex-maven-plugin.version&gt;</span>1.0.6<span class="nt">&lt;/jandex-maven-plugin.version&gt;</span>
    <span class="nt">&lt;capsule-maven-plugin.version&gt;</span>1.5.1<span class="nt">&lt;/capsule-maven-plugin.version&gt;</span>
  <span class="nt">&lt;/properties&gt;</span>

  <span class="nt">&lt;dependencyManagement&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jersey-bom<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${jersey.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
  <span class="nt">&lt;/dependencyManagement&gt;</span>

  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.jboss<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jandex<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${jandex.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.inject<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-cdi2-se<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.containers<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-container-netty-http<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${jersey.version}<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>

  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="c">&lt;!-- CDI index --&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.jboss.jandex<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jandex-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${jandex-maven-plugin.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;id&gt;</span>make-index<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>jandex<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;phase&gt;</span>process-classes<span class="nt">&lt;/phase&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>

      <span class="c">&lt;!-- fat jar --&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.github.chrisdchristo<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>capsule-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${capsule-maven-plugin.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>build<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;fileDesc&gt;</span>-all<span class="nt">&lt;/fileDesc&gt;</span>
              <span class="nt">&lt;appClass&gt;</span>${mainClass}<span class="nt">&lt;/appClass&gt;</span>
              <span class="nt">&lt;type&gt;</span>fat<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
</code></pre></div></div> <h3 id="entry-point"> <a href="#entry-point" class="anchor-heading"><svg class="d-inline-block v-align-middle" viewBox="0 0 16 16" version="1.1" width="18" height="18" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> entry point </h3> <p><em>Main.java</em></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Log4j2</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="kd">extends</span> <span class="nc">ResourceConfig</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">Main</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">packages</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="nc">Main</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getPackage</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Channel</span> <span class="n">server</span> <span class="o">=</span> <span class="nc">NettyHttpContainerProvider</span><span class="o">.</span><span class="na">createHttp2Server</span><span class="o">(</span>
                <span class="no">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">"http://127.0.0.1:8080/"</span><span class="o">),</span>
                <span class="nc">ResourceConfig</span><span class="o">.</span><span class="na">forApplicationClass</span><span class="o">(</span><span class="nc">Main</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
                <span class="kc">null</span><span class="o">);</span>

        <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="nl">server:</span><span class="o">:</span><span class="n">close</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="fallback"> <a href="#fallback" class="anchor-heading"><svg class="d-inline-block v-align-middle" viewBox="0 0 16 16" version="1.1" width="18" height="18" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> fallback </h3> <p><em>ErrorMapper.java</em></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Log4j2</span>
<span class="nd">@Provider</span>
<span class="nd">@RequestScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ErrorMapper</span> <span class="kd">implements</span> <span class="nc">ExceptionMapper</span><span class="o">&lt;</span><span class="nc">Exception</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Context</span>
    <span class="nc">UriInfo</span> <span class="n">uriInfo</span><span class="o">;</span>

    <span class="nd">@Context</span>
    <span class="nc">Request</span> <span class="n">request</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Response</span> <span class="nf">toResponse</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"{} {}"</span><span class="o">,</span> <span class="n">request</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(),</span> <span class="n">exception</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">(),</span> <span class="n">exception</span><span class="o">);</span>

        <span class="k">return</span> <span class="nc">Response</span><span class="o">.</span><span class="na">status</span><span class="o">(</span><span class="nc">Response</span><span class="o">.</span><span class="na">Status</span><span class="o">.</span><span class="na">BAD_REQUEST</span><span class="o">)</span>
                       <span class="o">.</span><span class="na">entity</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="na">createObjectBuilder</span><span class="o">()</span>
                                   <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"error"</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">exception</span><span class="o">.</span><span class="na">getLocalizedMessage</span><span class="o">())</span>
                                                         <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="s">"empty"</span><span class="o">))</span>
                                   <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"_links"</span><span class="o">,</span> <span class="nc">Json</span><span class="o">.</span><span class="na">createObjectBuilder</span><span class="o">()</span>
                                                      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"_self"</span><span class="o">,</span> <span class="n">uriInfo</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span>
                                                                           <span class="o">.</span><span class="na">toString</span><span class="o">())</span>
                                                      <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                                   <span class="o">.</span><span class="na">build</span><span class="o">())</span>
                       <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
                       <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p><em>HealthResource.java</em> + some fallback also:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestScoped</span>
<span class="nd">@Consumes</span><span class="o">(</span><span class="no">WILDCARD</span><span class="o">)</span>
<span class="nd">@Produces</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HealthResource</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">on</span><span class="o">(</span><span class="nd">@Observes</span> <span class="nc">ContainerInitialized</span> <span class="n">containerInitializedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">containerInitializedEvent</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GET</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">"health"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">JsonObject</span> <span class="nf">health</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"health"</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Json</span><span class="o">.</span><span class="na">createObjectBuilder</span><span class="o">()</span>
                   <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"status"</span><span class="o">,</span> <span class="s">"UP"</span><span class="o">)</span>
                   <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@GET</span>
    <span class="nd">@Path</span><span class="o">(</span><span class="s">"{path:(.*)?}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">JsonObject</span> <span class="nf">getAny</span><span class="o">(</span><span class="nd">@PathParam</span><span class="o">(</span><span class="s">"path"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"unexpected GET"</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">info</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">JsonObject</span> <span class="nf">info</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Json</span><span class="o">.</span><span class="na">createObjectBuilder</span><span class="o">()</span>
                   <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"path"</span><span class="o">,</span> <span class="s">""</span> <span class="o">+</span> <span class="n">path</span><span class="o">)</span>
                   <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h2 id="jackson-json-support"> <a href="#jackson-json-support" class="anchor-heading"><svg class="d-inline-block v-align-middle" viewBox="0 0 16 16" version="1.1" width="18" height="18" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> Jackson JSON support </h2> <p>maven dependencies in <em>pom.xml</em> file</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;jersey.version&gt;</span>2.29<span class="nt">&lt;/jersey.version&gt;</span>
    <span class="nt">&lt;jackson.version&gt;</span>2.10.0.pr2<span class="nt">&lt;/jackson.version&gt;</span>
  <span class="nt">&lt;/properties&gt;</span>

  <span class="nt">&lt;dependencyManagement&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jersey-bom<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${jersey.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jackson-bom<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${jackson.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
  <span class="nt">&lt;/dependencyManagement&gt;</span>

  <span class="nt">&lt;dependencies&gt;</span>
    <span class="c">&lt;!-- Jackson Jersey support --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.containers<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-container-netty-http<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!--
      1. Serialization / Deserialization of abstract types (such as DomainEvent)
         by using Jackson type feature
      2. REST API: Input List of DomainEvents as Request Body
    --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.media<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-media-json-jackson<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- REST API: javax.json.Json / javax.json.JsonObject --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.glassfish.jersey.media<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jersey-media-json-processing<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- Jackson ObjectMapper --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- ZonedDateTime Format and Serialization / Deserialization --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.datatype<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>jackson-datatype-jsr310<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div></div> <p>In order to let Jackson properly understand how to deserialize json into abstract type, we have to configure its abstract type mappings (see <code class="highlighter-rouge">@@JsonSubTypes</code> annotations):</p> <p><em>DomainEvent.java</em></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@JsonTypeInfo</span><span class="o">(</span>
        <span class="n">use</span> <span class="o">=</span> <span class="nc">JsonTypeInfo</span><span class="o">.</span><span class="na">Id</span><span class="o">.</span><span class="na">NAME</span><span class="o">,</span>
        <span class="n">property</span> <span class="o">=</span> <span class="s">"type"</span>
<span class="o">)</span>
<span class="nd">@JsonSubTypes</span><span class="o">({</span>
        <span class="nd">@JsonSubTypes</span><span class="o">.</span><span class="na">Type</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"CounterCreated"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nc">CounterCreated</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="nd">@JsonSubTypes</span><span class="o">.</span><span class="na">Type</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"CounterIncremented"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nc">CounterIncremented</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
        <span class="nd">@JsonSubTypes</span><span class="o">.</span><span class="na">Type</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"CounterSuspended"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nc">CounterSuspended</span><span class="o">.</span><span class="na">class</span><span class="o">),</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DomainEvent</span> <span class="o">{</span>
    <span class="no">UUID</span> <span class="nf">getAggregateId</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> <p>All events are ValueObjects and can be created only via single constructor. In order to help Jackson properly understand how all these events can be deserialized into Java Object, we have to setup it’s <code class="highlighter-rouge">@JsonCreator</code> together with <code class="highlighter-rouge">@JsonProperty</code> pointing to concrete object field…</p> <p>Also, we don’t wanna show any empty or null fields in case they are has not been specified, so we are using <code class="highlighter-rouge">@JsonInclude</code> annotations…</p> <p>By design, all our event should should be relative to concrete aggregate, so they should have aggregateId as well:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CounterCreated</span> <span class="kd">implements</span> <span class="nc">DomainEvent</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">eventName</span> <span class="o">=</span> <span class="nc">CounterCreated</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>

    <span class="nd">@JsonInclude</span><span class="o">(</span><span class="nc">JsonInclude</span><span class="o">.</span><span class="na">Include</span><span class="o">.</span><span class="na">NON_NULL</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="no">UUID</span> <span class="n">aggregateId</span><span class="o">;</span>

    <span class="nd">@JsonInclude</span><span class="o">(</span><span class="nc">JsonInclude</span><span class="o">.</span><span class="na">Include</span><span class="o">.</span><span class="na">NON_EMPTY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">counterName</span><span class="o">;</span>

    <span class="nd">@JsonInclude</span><span class="o">(</span><span class="nc">JsonInclude</span><span class="o">.</span><span class="na">Include</span><span class="o">.</span><span class="na">NON_NULL</span><span class="o">)</span>
    <span class="nd">@JsonFormat</span><span class="o">(</span><span class="n">shape</span> <span class="o">=</span> <span class="nc">JsonFormat</span><span class="o">.</span><span class="na">Shape</span><span class="o">.</span><span class="na">STRING</span><span class="o">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s">"yyyy-MM-dd'T'HH:mm:ss.SSSZ"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ZonedDateTime</span> <span class="n">at</span><span class="o">;</span>

    <span class="nd">@JsonCreator</span>
    <span class="kd">public</span> <span class="nf">CounterCreated</span><span class="o">(</span><span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"aggregateId"</span><span class="o">)</span> <span class="no">UUID</span> <span class="n">aggregateId</span><span class="o">,</span>
                          <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"counterName"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">counterName</span><span class="o">,</span>
                          <span class="nd">@JsonProperty</span><span class="o">(</span><span class="s">"at"</span><span class="o">)</span> <span class="nc">ZonedDateTime</span> <span class="n">at</span><span class="o">)</span> <span class="o">{</span>

        <span class="k">this</span><span class="o">.</span><span class="na">aggregateId</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">aggregateId</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">counterName</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">counterName</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"counter-%d"</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">at</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">at</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="nc">ZonedDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h3 id="zoneddatetime"> <a href="#zoneddatetime" class="anchor-heading"><svg class="d-inline-block v-align-middle" viewBox="0 0 16 16" version="1.1" width="18" height="18" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a> ZonedDateTime </h3> <p>In order to have properly consumable format of <code class="highlighter-rouge">java.timr.ZonedDateTime</code> type, we have to configure Jackson <code class="highlighter-rouge">ObjectMapper</code> to be used in our serialization process in our app:</p> <p><em>JacksonConfig.java</em></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ApplicationScoped</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JacksonConfig</span> <span class="o">{</span>

    <span class="nd">@Produces</span>
    <span class="kd">private</span> <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="nc">JsonMapper</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                                                  <span class="o">.</span><span class="na">addModules</span><span class="o">(</span><span class="k">new</span> <span class="nc">JavaTimeModule</span><span class="o">())</span>
                                                  <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">WRITE_DATES_AS_TIMESTAMPS</span><span class="o">)</span>
                                                  <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">WRITE_DURATIONS_AS_TIMESTAMPS</span><span class="o">)</span>
                                                  <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">DeserializationFeature</span><span class="o">.</span><span class="na">READ_DATE_TIMESTAMPS_AS_NANOSECONDS</span><span class="o">)</span>
                                                  <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">WRITE_DATE_TIMESTAMPS_AS_NANOSECONDS</span><span class="o">)</span>
                                                  <span class="o">.</span><span class="na">disable</span><span class="o">(</span><span class="nc">SerializationFeature</span><span class="o">.</span><span class="na">FAIL_ON_EMPTY_BEANS</span><span class="o">)</span>
                                                  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> <p>But we have to also care about Jersey! So we should properly configure Jersey ObjectMapper <code class="highlighter-rouge">ContextResolver</code> via provider</p> <p><em>JacksonProvider</em></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Provider</span>
<span class="nd">@ApplicationScoped</span>
<span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JacksonProvider</span> <span class="kd">implements</span> <span class="nc">ContextResolver</span><span class="o">&lt;</span><span class="nc">ObjectMapper</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nc">ObjectMapper</span> <span class="n">objectMapper</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">ObjectMapper</span> <span class="nf">getContext</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">objectMapper</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>Because we previously configure <code class="highlighter-rouge">ObjectMapper</code> in <code class="highlighter-rouge">JacksonConfig.java</code> file we can (and should) re-use it!</p> <hr> <footer role="contentinfo"> <p class="text-small text-grey-dk-000 mb-0">Jersey Netty CDI Jackson File based EventStore. Copyright &copy; 2019 Maksim Kostromin.</p> </footer> </div> </div> </div> </div> </body> </html>
